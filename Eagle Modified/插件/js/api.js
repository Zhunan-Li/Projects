var pixelRatio,isFirefox=navigator.userAgent.indexOf("Firefox")>-1,captureImages=[];function getChromeVersion(){var e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);return!!e&&parseInt(e[2],10)}window.jQuery=$;var chromeVersion=getChromeVersion()||0,CHROME_MAX_PRIMARY_DIMENSION=32750,MAX_PRIMARY_DIMENSION=32750,MAX_AREA=268435456;chromeVersion>=76&&(MAX_PRIMARY_DIMENSION=65500,CHROME_MAX_PRIMARY_DIMENSION=65500);var rect=void 0,matches=["http://*/*","https://*/*","ftp://*/*","file://*/*"],noMatches=[/^https?:\/\/chrome.google.com\/.*$/];function isValidUrl(e){var t;for(t=noMatches.length-1;t>=0;t--)if(noMatches[t].test(e))return!1;for(t=matches.length-1;t>=0;t--)if(new RegExp("^"+matches[t].replace(/\*/g,".*")+"$").test(e))return!0;return!1}function initiateCapture(e){captureImages=[],chrome.tabs.sendMessage(e.id,{msg:"scrollPage"},function(){})}function captureVisibleTab(e,t,a){var i=a.windowId||null;a.id;chrome.tabs.captureVisibleTab(i,{format:"png",quality:100},function(i){if(i){var r=new Image,n=function(){r.removeEventListener("load",n),captureImages.push({image:this,data:e}),t(!0),1===e.complete&&generateCaptureCanvas(a)};r.addEventListener("load",n),r.src=i}})}function generateCaptureCanvas(e=null){var t=(MAX_PRIMARY_DIMENSION=CHROME_MAX_PRIMARY_DIMENSION)*rect.width*pixelRatio;t>MAX_AREA&&(MAX_PRIMARY_DIMENSION*=MAX_AREA/t),MAX_PRIMARY_DIMENSION=Math.min(MAX_PRIMARY_DIMENSION,CHROME_MAX_PRIMARY_DIMENSION);for(var a=99999999,i=captureImages[0].image.height,r=0;r<captureImages.length;r++){var n=captureImages[r].data.y*pixelRatio;n<a&&(a=n)}var o=0,g=[],h=[],c=0;captureImages=captureImages.sort(function(e,t){return e.data.y-t.data.y});for(r=0;r<captureImages.length;r++){var u=captureImages[r];o+u.image.height>MAX_PRIMARY_DIMENSION?(o=0,g.push(h),h=[]):o+=u.image.height,h.push(u)}h.length>0&&g.push(h);var s=[];c=0;const l=pixelRatio>1&&!useRetina;g.forEach(function(e){var t;t=(e=e.sort(function(e,t){return t.data.y-e.data.y}))[0].data.y*pixelRatio-a+i-c;var r=document.createElement("canvas"),n=r.getContext("2d");r.height=Math.min(t,MAX_PRIMARY_DIMENSION),r.width=e[0].image.width,l&&(r.height/=pixelRatio,r.width/=pixelRatio),e.forEach(function(e){let t=e.data.y*pixelRatio-a-c;if(l){let a=e.image.width,i=e.image.height,r=0,o=t/pixelRatio,g=e.image.width/pixelRatio,h=e.image.height/pixelRatio;n.drawImage(e.image,0,0,a,i,r,o,g,h)}else n.drawImage(e.image,0,t);e.image.src="",e.image=null,delete e.image}),s.push(r),c+=t}),logger.info(`[background] merge ${g.length} piece image...`),captureImages=[];var m=1;useRetina?m=pixelRatio:a/=pixelRatio;let I=rect.x*m,p=rect.y*m,M=rect.width*m,d=rect.height*m,R=0,f=0,A=0,_=[],v=Math.ceil(d/MAX_PRIMARY_DIMENSION),E=d;for(let e=1;e<=v;e++){let t=document.createElement("canvas");t.width=M,t.height=MAX_PRIMARY_DIMENSION,E-MAX_PRIMARY_DIMENSION>0&&(E-=MAX_PRIMARY_DIMENSION),e==v&&(t.height=E),_.push(t)}0!==_.length&&(s.forEach((e,t,i)=>{let r=_[A],n=r.getContext("2d"),o=e.getContext("2d");if(0===t){let t=e.height-(p-a),i=o.getImageData(I,p-a,M,t);n.putImageData(i,0,0),R=t,f=0}if(0!=t){if(R<r.height){let t=r.height-R,a=e.height-f;if(t<a){let e=o.getImageData(I,f,M,t);n.putImageData(e,0,R),f+=t,R+=t}else{let e=o.getImageData(I,f,M,a);n.putImageData(e,0,R),f+=a,R+=a}}if(_[A+1]&&f<e.height){R=0,n=(r=_[++A]).getContext("2d");r.height;let t=e.height-f,a=o.getImageData(I,f,M,t);n.putImageData(a,0,R),f=0,R+=t}R>=MAX_PRIMARY_DIMENSION&&A++,f>=e.height&&(f=0)}}),logger.info(`[background] return canvas count[${_.length}] totalHeight[${d}]`),returnCanvases(_,e),s.forEach(function(e){e.getContext("2d").clearRect(0,0,e.width,e.height),e=null}))}function resizeCanvas(e,t){var a=document.createElement("canvas"),i=a.getContext("2d"),r=1*e.width/t,n=1*e.height/t;return a.width=r,a.height=n,i.drawImage(e,0,0,r,n),a}function startCapture(e){var t=!1,a=!1;isValidUrl(e.url)||errback("invalid url"),rect=void 0,chrome.tabs.executeScript(e.id,{file:"/js/utils/page.js"},function(){a?console.error("Timed out too early while waiting for chrome.tabs.executeScript. Try increasing the timeout."):(t=!0,initiateCapture(e))}),window.setTimeout(function(){t||(a=!0,errback("execute timeout"))},3e3)}function doCapture(e,t,a){if("capture"===e.msg){if(e.rect)rect=e.rect;else{let t={width:e.totalWidth,height:e.totalHeight,x:0,y:0};rect=t}captureVisibleTab(e,a,t.tab)}}function webCapture(e,t,a,i,r){pixelRatio=r||1,startCapture(e)}function returnCanvases(e,t=null){var a=Date.now(),i=localStorage.getItem("captureFormat")||"png";e.length>20&&(e.length=20),e.forEach(function(a,r){a&&function(i,r){setTimeout(function(){logger.info(`[background] save capture fillpage[${t.url}] w[${a.width}] h[${a.height}] base64[${i.length}] index[${r}]`),e.length>1?finishCaptures(i,r+1):finishCaptures(i)},500*r)}("png"===i?a.toDataURL():a.toDataURL("image/jpeg",1),r)});var r=Date.now()-a;setTimeout(function(){chrome.tabs.sendMessage(t.id,{action:"hide-save-to-eagle-dialog"},function(e){})},r)}