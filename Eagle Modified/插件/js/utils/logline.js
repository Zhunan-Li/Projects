!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Logline=t()}(this,function(){"use strict";var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},o=function(){function e(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,o,r){return o&&e(t.prototype,o),r&&e(t,r),t}}(),r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(e[r]=o[r])}return e},n=function e(t,o,r){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,o);if(void 0===n){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,o,r)}if("value"in n)return n.value;var i=n.get;return void 0!==i?i.call(r):void 0},a=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},c=r({},{verbose:!0});function s(e,t){var o={};"string"==typeof e?o[e]=t:"[object Object]"===Object.prototype.toString.call(e)&&(o=e),r(c,o)}var u=s;u.set=s,u.get=function(e){return e?c[e]:c};var l=window.console,f={INFO:"log",WARN:"warn",ERROR:"error",CRITICAL:"error"};function p(e){l&&console.error("Logline: "+e)}function d(e,t,o,r){l&&u.get().verbose&&window.console[f[t.toUpperCase()]||f.INFO]("["+e+"] "+t.toUpperCase()+" "+o,r||"")}var g=function(){function e(o){t(this,e),this._namespace=o}return o(e,[{key:"_record",value:function(e,t,o){p("method _record is not implemented.")}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];this._record.apply(this,["info"].concat(t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];this._record.apply(this,["warn"].concat(t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];this._record.apply(this,["error"].concat(t))}},{key:"critical",value:function(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];this._record.apply(this,["critical"].concat(t))}}],[{key:"init",value:function(e){return!0}},{key:"transTimeFormat",value:function(e,t){if(!e||/^\d{13}$/.test(e))return+e;if(t&&!/^\d{13}$/.test(t))throw new TypeError("relative time should be standard unix timestamp");return(t||Date.now())-24*e.replace(/d$/,"")*3600*1e3}},{key:"get",value:function(e,t,o){p("method get is not implemented.")}},{key:"keep",value:function(e){p("method keep is not implemented.")}},{key:"clean",value:function(){p("method clean is not implemented.")}},{key:"STATUS",get:function(){return{INITING:1,INITED:2,FAILED:4}}}]),e}(),_=function(){function e(){t(this,e),this._pool=[]}return o(e,[{key:"push",value:function(e,t){e.context=t,this._pool.push(e)}},{key:"consume",value:function(){for(var e;e=this._pool.shift();)e.call(e.context)}}]),e}(),y=function(r){function c(){var e;t(this,c);for(var o=arguments.length,r=Array(o),n=0;n<o;n++)r[n]=arguments[n];return i(this,(e=c.__proto__||Object.getPrototypeOf(c)).call.apply(e,[this].concat(r)))}return a(c,g),o(c,[{key:"_record",value:function(t,o,r){var n=this;try{if(c.status!==g.STATUS.INITED)return c._pool.push(function(){return n._record(t,o,r)}),void(c.status!==g.STATUS.INITING&&c.init());d(this._namespace,t,o,r);var a=c.db.transaction(["logs"],"readwrite");a.onerror=function(e){return p(e.target.error)},a.objectStore("logs").add({time:Date.now(),level:t,namespace:this._namespace,descriptor:o,data:function t(o){var r,n={};if("object"!==(void 0===o?"undefined":e(o)))return o;for(r in o)o.hasOwnProperty(r)&&"function"!=typeof o[r]&&(n[r]=t(o[r]));return n}(r)}).onerror=function(e){c.status=g.STATUS.FAILED,p(e.target.error)}}catch(e){p("failed to write, "+e.message)}}}],[{key:"init",value:function(e){var t=this;try{if(c.support||p("your platform does not support indexeddb protocol."),c.status)return!1;c._pool=c._pool||new _,c._database=e||"logline",c.status=n(c.__proto__||Object.getPrototypeOf(c),"STATUS",this).INITING,c.request=window.indexedDB.open(c._database),c.request.onerror=function(e){return p("protocol indexeddb is prevented.")},c.request.onsuccess=function(e){c.db=e.target.result,c.status=n(c.__proto__||Object.getPrototypeOf(c),"STATUS",t).INITED,c._pool.consume(),c.db.onerror=function(e){return p(e.target.error)}},c.request.onupgradeneeded=function(e){var t=e.target.result.createObjectStore("logs",{autoIncrement:!0});t.createIndex("namespace","namespace",{unique:!1}),t.createIndex("level","level",{unique:!1}),t.createIndex("descriptor","descriptor",{unique:!1}),t.createIndex("data","data",{unique:!1})}}catch(e){p("failed init, "+e.message)}}},{key:"get",value:function(e,t,o){try{if(c.status!==n(c.__proto__||Object.getPrototypeOf(c),"STATUS",this).INITED)return c._pool.push(function(){return c.get(e,t,o)});e=g.transTimeFormat(e),t=g.transTimeFormat(t);var r=c._getTransactionStore(IDBTransaction.READ_ONLY);if(!r)return o([]);if(r.getAll){var a=void 0,i=[];r.getAll().onsuccess=function(r){a=r.target.result;for(var n=0;n<a.length;n++)e&&a[n].time<e||t&&a[n].time>t||i.push(a[n]);o(i)}}else{var s=r.openCursor(),u=[];s.onsuccess=function(r){var n=r.target.result;if(n){if(e&&n.value.time<e||t&&n.value.time>t)return n.continue();u.push({time:n.value.time,level:n.value.level,namespace:n.value.namespace,descriptor:n.value.descriptor,data:n.value.data}),n.continue()}else o(u)}}}catch(e){p("failed to get logs, "+e.message)}}},{key:"keep",value:function(e){try{if(c.status!==n(c.__proto__||Object.getPrototypeOf(c),"STATUS",this).INITED)return c._pool.push(function(){return c.keep(e)});var t=c._getTransactionStore("readwrite");if(!t)return!1;if(e){var o=Date.now()-24*(e||2)*3600*1e3,r=t.openCursor();r.onsuccess=function(e){var r=e.target.result;r&&r.value.time<o&&(t.delete(r.primaryKey),r.continue())},r.onerror=function(t){return p("unable to locate logs earlier than "+e+"d.")}}else t.clear().onerror=function(e){return p(e.target.error)}}catch(e){p("failed to keep logs, "+e.message)}}},{key:"clean",value:function(){try{if(c.status!==n(c.__proto__||Object.getPrototypeOf(c),"STATUS",this).INITED)return c._pool.push(function(){return c.clean()});c.db.close();var e=window.indexedDB.deleteDatabase(c._database);e.onerror=function(e){return p(e.target.error)},e.onsuccess=function(e){delete c.status,delete c.db}}catch(e){p("failed to cleanup logs, "+e.message)}}},{key:"_getTransactionStore",value:function(e){try{if(c.db){var t=c.db.transaction(["logs"],e||"readwrite");return t.onerror=function(e){return p(e.target.error)},t.objectStore("logs")}p("log database is not created or connections are closed, considering init it.")}catch(e){return p("failed to generate new transaction, "+e.message),!1}}},{key:"support",get:function(){return!!(window.indexedDB&&window.IDBTransaction&&window.IDBKeyRange)}}]),c}(),v=function(e){function r(){var e;t(this,r);for(var o=arguments.length,n=Array(o),a=0;a<o;a++)n[a]=arguments[a];return i(this,(e=r.__proto__||Object.getPrototypeOf(r)).call.apply(e,[this].concat(n)))}return a(r,g),o(r,[{key:"_record",value:function(e,t,o){var n;try{(n=window.localStorage.getItem(r._database)?JSON.parse(window.localStorage.getItem(r._database)):[]).push([Date.now(),this._namespace,e,t,o]),d(this._namespace,e,t,o),window.localStorage.setItem(r._database,JSON.stringify(n))}catch(e){window.localStorage.removeItem(r._database),window.localStorage.setItem(r._database,JSON.stringify([])),p("failed to write, may be localStorage is full, "+e.message)}}}],[{key:"init",value:function(e){try{r.support||p("your platform does not support localstorage protocol."),r._database=e||"logline",window.localStorage.getItem(r._database)||window.localStorage.setItem(r._database,JSON.stringify([])),r.status=n(r.__proto__||Object.getPrototypeOf(r),"STATUS",this).INITED}catch(e){p("failed to init, "+e.message)}}},{key:"get",value:function(e,t,o){var n,a;try{for(n=JSON.parse(window.localStorage.getItem(r._database)),e=g.transTimeFormat(e),t=g.transTimeFormat(t),a=0;a<n.length;a++)e&&n[a][0]<e||t&&n[a][0]>t||(n[a]={time:n[a][0],namespace:n[a][1],level:n[a][2],descriptor:n[a][3],data:n[a][4]});o(n)}catch(e){p("failed to get, "+e.message),o([])}}},{key:"keep",value:function(e){var t;try{t=e?(window.localStorage.getItem(r._database)?JSON.parse(window.localStorage.getItem(r._database)):[]).filter(function(t){return t.time>=Date.now()-24*(e||2)*3600*1e3}):[],window.localStorage.setItem(r._database,JSON.stringify(t))}catch(e){p("failed to keep, "+e.message)}}},{key:"clean",value:function(){try{delete r.status,window.localStorage.removeItem(r._database)}catch(e){p("failed to clean, "+e.message)}}},{key:"support",get:function(){return"localStorage"in window}}]),r}(),m=function(e){function r(){var e;t(this,r);for(var o=arguments.length,n=Array(o),a=0;a<o;a++)n[a]=arguments[a];return i(this,(e=r.__proto__||Object.getPrototypeOf(r)).call.apply(e,[this].concat(n)))}return a(r,g),o(r,[{key:"_record",value:function(e,t,o){var n=this;if(r.status!==g.STATUS.INITED)return r._pool.push(function(){return n._record(e,t,o)}),void(r.status!==g.STATUS.INITING&&r.init());try{d(this._namespace,e,t,o),r._db.transaction(function(r){r.executeSql("INSERT INTO logs (time, namespace, level, descriptor, data) VALUES(?, ?, ?, ? ,?)",[Date.now(),n._namespace,e,t,void 0===o||""===o?"":JSON.stringify(o)||""],function(){},function(e,t){p("write error, "+t.message)})})}catch(e){p("error inserting record, "+e.message)}}}],[{key:"init",value:function(e){var t=this;if(r.support||p(new Error("your platform does not support websql protocol.")),r.status)return!1;r._pool=r._pool||new _,r._database=e||"logline",r.status=n(r.__proto__||Object.getPrototypeOf(r),"STATUS",this).INITING;try{r._db=window.openDatabase(r._database,"1.0","cats loves logs",5085593.6),r._db.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS logs (time, namespace, level, descriptor, data)",[],function(){r.status=n(r.__proto__||Object.getPrototypeOf(r),"STATUS",t).INITED,r._pool.consume()},function(e,o){r.status=n(r.__proto__||Object.getPrototypeOf(r),"STATUS",t).FAILED,p("unable to create table, "+o.message)})})}catch(e){p("unable to init log database, "+e.message)}}},{key:"get",value:function(e,t,o){if(r.status!==n(r.__proto__||Object.getPrototypeOf(r),"STATUS",this).INITED)return r._pool.push(function(){return r.get(e,t,o)});e=g.transTimeFormat(e),t=g.transTimeFormat(t);try{r._db.transaction(function(r){r.executeSql("SELECT * FROM logs ORDER BY time DESC",[],function(r,n){for(var a,i,c=[],s=n.rows.length;--s>=0;)if(i=n.rows.item(s),!(e&&i.time<e||t&&i.time>t)){a=JSON.parse(JSON.stringify(i));try{a.data=JSON.parse(a.data)}catch(e){}c.push(a)}o(c)},function(e,t){p(t.message)})})}catch(e){p("unable to collect logs from database.")}}},{key:"keep",value:function(e){if(r.status!==n(r.__proto__||Object.getPrototypeOf(r),"STATUS",this).INITED)return r._pool.push(function(){return r.keep(e)});try{r._db.transaction(function(t){e?t.executeSql("DELETE FROM logs WHERE time < ?",[Date.now()-24*(e||2)*3600*1e3],function(){},function(e,t){p(t.message)}):t.executeSql("DELETE FROM logs",[],function(){},function(e,t){p(t.message)})})}catch(e){p("unable to clean logs from database.")}}},{key:"clean",value:function(){if(r.status===n(r.__proto__||Object.getPrototypeOf(r),"STATUS",this).INITED)try{r._db.transaction(function(e){e.executeSql("DROP TABLE logs",[],function(){delete r.status},function(e,t){p(t.message)})})}catch(e){p("unable to clean log database.")}else r._pool.push(function(){return r.clean()})}},{key:"support",get:function(){return"openDatabase"in window}}]),r}(),h=function(){function e(o){if(t(this,e),!(this instanceof e))return new e(o);try{return e._checkProtocol(),new e._protocol(o)}catch(e){return new g(o)}}return o(e,null,[{key:"_initProtocol",value:function(t){e._protocol=t,e._protocol.init(e._database||"logline")}},{key:"_checkProtocol",value:function(){if(!e._protocol){for(var t=Object.keys(e.PROTOCOL),o=void 0;o=e.PROTOCOL[t.shift()];)if(o.support)return void e._initProtocol(o);p("protocols "+t.join(", ").toLowerCase()+" are not supported on this platform")}}},{key:"get",value:function(t,o,r){switch(e._checkProtocol(),arguments.length){case 1:r=t,t=void 0;break;case 2:r=o,o=void 0}e._protocol.get(t,o,r)}},{key:"all",value:function(t){e.get(t)}},{key:"keep",value:function(t){return e._checkProtocol(),e._protocol.keep(t),this}},{key:"clean",value:function(){return e._checkProtocol(),e._protocol.clean(),this}},{key:"using",value:function(t,o){return-1===[y,v,m].indexOf(t)&&p("specialfied protocol "+(t?t+" ":"")+"is not available"),e._protocol?this:(e.database(o||e._database),e._initProtocol(t),this)}},{key:"database",value:function(t){e._database=t}},{key:"config",get:function(){return u}}]),e}();return h.PROTOCOL={INDEXEDDB:y,LOCALSTORAGE:v,WEBSQL:m},h.INTERFACE=Object.freeze(g),h.env={verbose:!0},h});